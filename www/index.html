<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Editor Markdown ao Vivo</title>
    <style>
        :root {
            --font: 16px "SF Mono", Consolas, monospace;
            --line-height: 1.5;
            --padding: 12px;
        }

        body {
            font-family: system-ui, sans-serif;
            background: #f5f5f5;
            display: flex;
            justify-content: center;
            padding: 1rem;
        }

        #container {
            position: relative;
            width: 100%;
            max-width: 700px;
        }

        /* ÁREA DE TEXTO INVISÍVEL */
        #input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            resize: none;
            border: none;
            outline: none;
            background: transparent;
            color: transparent;
            /* invisível */
            caret-color: black;
            /* mantém o cursor */
            font: var(--font);
            line-height: var(--line-height);
            padding: var(--padding);
            white-space: pre-wrap;
            overflow: auto;
            z-index: 2;
        }

        label span {
            display: inline-block;
            margin-left: 2em;
            /* deixa o texto começar mais à direita, mesmo sem mudar a checkbox */
        }


        /* VISUALIZAÇÃO */
        #preview {
            border: 1px solid #ccc;
            border-radius: 10px;
            background: white;
            font: var(--font);
            line-height: var(--line-height);
            padding: var(--padding);
            min-height: 300px;
            white-space: pre-wrap;
            pointer-events: auto;
            color: #222;
            overflow: hidden;
        }

        input[type="checkbox"] {
            position: relative;
            transform: scale(1.2);
            margin-right: 6px;
            pointer-events: auto;
            cursor: pointer;
            overflow: auto;
            z-index: 31;
        }

        .done {
            text-decoration: line-through;
            color: #777;
            margin-left: 1.4em;
        }
    </style>
</head>

<body>
    <div id="container">
        <textarea id="input" placeholder="Escreva suas tarefas em Markdown..."></textarea>
        <div id="preview"></div>
    </div>

    <script>
        const input = document.getElementById("input");
        const preview = document.getElementById("preview");

        // --- Função que converte markdown simples em HTML ---
        function renderMarkdown(text) {
            return text
                .replace(/^(\s*)- \[ \] (.*)$/gm, '$1<label><input type="checkbox"><span>$2</span></label>')
                .replace(/^(\s*)- \[x\] (.*)$/gm, '$1<label><input type="checkbox" checked> <span class="done">$2</span></label>')
                .replace(/^### (.*)$/gm, "<h3>$1</h3>")
                .replace(/^## (.*)$/gm, "<h2>$1</h2>")
                .replace(/^# (.*)$/gm, "<h1>$1</h1>")
                .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
                .replace(/\*(.*?)\*/g, "<em>$1</em>");
        }

        // --- Atualiza visualização em tempo real ---
        function update() {
            preview.innerHTML = renderMarkdown(input.value);
            attachCheckboxEvents();
            syncScroll();
        }

        // --- Sincroniza rolagem ---
        function syncScroll() {
            preview.scrollTop = input.scrollTop;
        }

        // --- Checkbox interativo ---
        function attachCheckboxEvents() {
            preview.querySelectorAll("input[type='checkbox']").forEach((cb, i) => {
                cb.addEventListener("change", () => {
                    const lines = input.value.split("\n");
                    let count = 0;
                    for (let idx = 0; idx < lines.length; idx++) {
                        if (lines[idx].match(/^(\s*)- \[( |x)\]/i)) {
                            if (count === i) {
                                lines[idx] = cb.checked
                                    ? lines[idx].replace("- [ ]", "- [x]")
                                    : lines[idx].replace("- [x]", "- [ ]");
                                break;
                            }
                            count++;
                        }
                    }
                    input.value = lines.join("\n");
                    update();
                });
            });
        }

        // --- Adiciona nova linha "- [ ]" ao pressionar Enter ---
        input.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
                e.preventDefault();
                const pos = input.selectionStart;
                const before = input.value.substring(0, pos);
                const after = input.value.substring(pos);
                input.value = before + "\n- [ ] " + after;
                input.selectionStart = input.selectionEnd = pos + 7;
                update();
            }
        });

        input.addEventListener("input", update);
        input.addEventListener("scroll", syncScroll);
        update();
    </script>
</body>

</html>